!| scenario                            |Prepare Environment                                              |
|Change Notification Body              |Session Review Requirement  ||${ReviewSessionNotificationBodyNew}|
|Add System To Collection              |${SystemName}               ||${Collection}                      |
|Add User To Group                     |${CLI_user_1}               ||\"Global PSM Requestor Group\"     |
|Add User To Group                     |${GlobalGroupApprover}      ||\"Global PSM Approver Group\"      |
|Add User To Group                     |${GlobalGroupRequestor}     ||\"Global PSM Requestor Group\"     |
|Add User To Group                     |${GlobalGroupReviewer}      ||\"Global PSM Reviewer Group\"      |
|Set Group Permissions Account Level   |${GroupAccountRequestors}   ||\"PSM Requestor\"                  |
|Set Group Permissions Account Level   |${GroupAccountApprovers}    ||\"${SessionApproverPolicy}\"       |
|Set Group Permissions Account Level   |${GroupAccountReviewers}    ||\"PSM Reviewer\"                   |
|Set Group Permissions System Level    |${GroupSystemRequestors}    ||\"PSM Requestor\"                  |
|Set Group Permissions System Level    |${GroupSystemApprovers}     ||\"${SessionApproverPolicy}\"       |
|Set Group Permissions System Level    |${GroupSystemReviewers}     ||\"PSM Reviewer\"                   |
|Set Group Permissions Collection Level|${GroupCollectionRequestors}||\"PSM Requestor\"                  |
|Set Group Permissions Collection Level|${GroupCollectionApprovers} ||\"${SessionApproverPolicy}\"       |
|Set Group Permissions Collection Level|${GroupCollectionReviewers} ||\"PSM Reviewer\"                   |
|Set User Permissions Account Level    |${UserAccountRequestor}     ||\"PSM Requestor\"                  |
|Set User Permissions Account Level    |${UserAccountApprover}      ||\"${SessionApproverPolicy}\"       |
|Set User Permissions Account Level    |${UserAccountReviewer}      ||\"PSM Reviewer\"                   |
|Set User Permissions System Level     |${UserSystemRequestor}      ||\"PSM Requestor\"                  |
|Set User Permissions System Level     |${UserSystemApprover}       ||\"${SessionApproverPolicy}\"       |
|Set User Permissions System Level     |${UserSystemReviewer}       ||\"PSM Reviewer\"                   |
|Set User Permissions Collection Level |${UserCollectionRequestor}  ||\"PSM Requestor\"                  |
|Set User Permissions Collection Level |${UserCollectionApprover}   ||\"${SessionApproverPolicy}\"       |
|Set User Permissions Collection Level |${UserCollectionReviewer}   ||\"PSM Reviewer\"                   |
|pause                                 |${ApplyNewPoliciesInterval}                                      |
|Login                                 |${TPAMURL}                  ||${TPAMAdmin}   |   |${DefaultPwd}  |
|pause                                 |20000                                                            |



!|scenario                             |Clear Environment                                                |
|Session Cleanup                       |${ManagedAccount}                                                |
|Change Notification Body              |Session Review Requirement  ||${ReviewSessionNotificationBodyOld}|
|Remove User From Group                |${CLI_user_1}               ||\"Global PSM Requestor Group\"     |
|Remove User From Group                |${GlobalGroupApprover}      ||\"Global PSM Approver Group\"      |
|Remove User From Group                |${GlobalGroupRequestor}     ||\"Global PSM Requestor Group\"     |
|Remove User From Group                |${GlobalGroupReviewer}      ||\"Global PSM Reviewer Group\"      |
|Remove User Permissions On Account    |${UserAccountRequestor}     ||\"PSM Requestor\"                  |
|Remove User Permissions On Account    |${UserAccountApprover}      ||\"${SessionApproverPolicy}\"       |
|Remove User Permissions On Account    |${UserAccountReviewer}      ||\"PSM Reviewer\"                   |
|Remove User Permissions On System     |${UserSystemRequestor}      ||\"PSM Requestor\"                  |
|Remove User Permissions On System     |${UserSystemApprover}       ||\"${SessionApproverPolicy}\"       |
|Remove User Permissions On System     |${UserSystemReviewer}       ||\"PSM Reviewer\"                   |
|Remove User Permissions On Collection |${UserCollectionRequestor}  ||\"PSM Requestor\"                  |
|Remove User Permissions On Collection |${UserCollectionApprover}   ||\"${SessionApproverPolicy}\"       |
|Remove User Permissions On Collection |${UserCollectionReviewer}   ||\"PSM Reviewer\"                   |
|Remove Group Permissions On Account   |${GroupAccountRequestors}   ||\"PSM Requestor\"                  |
|Remove Group Permissions On Account   |${GroupAccountApprovers}    ||\"${SessionApproverPolicy}\"       |
|Remove Group Permissions On Account   |${GroupAccountReviewers}    ||\"PSM Reviewer\"                   |
|Remove Group Permissions On System    |${GroupSystemRequestors}    ||\"PSM Requestor\"                  |
|Remove Group Permissions On System    |${GroupSystemApprovers}     ||\"${SessionApproverPolicy}\"       |
|Remove Group Permissions On System    |${GroupSystemReviewers}     ||\"PSM Reviewer\"                   |
|Remove Group Permissions On Collection|${GroupCollectionRequestors}||\"PSM Requestor\"                  |
|Remove Group Permissions On Collection|${GroupCollectionApprovers} ||\"${SessionApproverPolicy}\"       |
|Remove Group Permissions On Collection|${GroupCollectionReviewers} ||\"PSM Reviewer\"                   |
|Remove System From Collection         |${SystemName}               ||${Collection}                      |








############## Manage Sessions #####################

!|scenario  |Session Notifications|Requestor||Approver||Reviewer|
|$Requestor=|getEval              |"@Requestor"                 |
|$Approver= |getEval              |"@Approver"                  |
|$Reviewer= |getEval              |"@Reviewer"                  |
|Session Request                                                |
|Session Request Response                                       |
|Session Review Requirement                                     |
|Session Start And Expire                                       |


                                                                                                                                                            

!|scenario                           |Not Enough Approvers                                                                     |
|Set Approvers Count                 |${SystemName}                   ||${ManagedAccount}               ||100                  |
|Request Session via UI Not Immediate|${SystemName}                   ||${ManagedAccount}               ||$Requestor||submitted|
|pause                               |240000                                                                                   |
|Check Mail                          |$Requestor@${TPAMEMailDomain}   ||Not Enough Approvers for Request||Canceled             |
|Delete Mails                        |$Requestor@${TPAMEMailDomain}                                                            |
|Check All Mailboxes No Mail         |Not Enough Approvers for Request||Canceled                                               |
|Set Approvers Count                 |${SystemName}                   ||${ManagedAccount}               ||1                    |
#|Check Mail                          |${SystemEscalationEMail}        ||Not Enough Approvers for Request||Canceled             |
#|Delete Mails                        |${SystemEscalationEMail}                                                                 |




!|scenario                  |Session Request                                                        |
|Request Session            |${SystemName}                ||${ManagedAccount}           ||$Requestor|
|pause                      |240000                                                                 |
|Check Mail                 |$Requestor@${TPAMEMailDomain}||Session Request Notification||$RequestID|
|Check Mail                 |${SystemEscalationEMail}     ||Session Request Notification||$RequestID|
|Check Approvers Mailboxes  |Session Request Notification ||$RequestID                              |
|Delete Mails               |$Requestor@${TPAMEMailDomain}                                          |
|Delete Mails               |${SystemEscalationEMail}                                               |
|pause                      |120000                                                                 |
|Clear Approvers Mailboxes                                                                          |
|Check All Mailboxes No Mail|Session Request              ||$RequestID                              |



!|scenario                  |Session Request Response                                                                |
|Approve Session            |$Approver                                                                               |
|pause                      |120000                                                                                  |
|Check Mail                 |$Requestor@${TPAMEMailDomain}        ||Session Request Response Notification||$RequestID|
|Check Approvers Mailboxes  |Session Request Response Notification||$RequestID                                       |
|Delete Mails               |$Requestor@${TPAMEMailDomain}                                                           |
|Clear Approvers Mailboxes                                                                                           |
|Check All Mailboxes No Mail|Session Request                      ||$RequestID                                       |


!|scenario                  |Session Review Requirement                                                                                                                              |
|Open Session               |$Requestor                                                                                                                                              |
|pause                      |120000                                                                                                                                                  |
|Check Reviewers Mailboxes  |Session Review Requirement Notification||A session (request #$RequestID) for account ${ManagedAccount} on System ${SystemName} was started by $Requestor|
|Check Reviewers Mailboxes  |Session Review Requirement Notification||${RequestReason}                                                                                               |
|Clear Reviewers Mailboxes                                                                                                                                                           |
|Check All Mailboxes No Mail|Session Review                         ||$RequestID                                                                                                     |



!|scenario   |Overdue Session Review Requirement                                                            |
|pause       |3600000                                                                                       |
|Check Mail  |${SessionReviewerEscalationEMail}||Overdue Session Review Requirement Notification||$RequestID|
|Delete Mails|${SessionReviewerEscalationEMail}                                                             |




!|scenario                  |Session Start And Expire                                               |
|Check Mail                 |${SessionStartContactEMail}  ||Session Start Notification  ||$RequestID|
|Delete Mails               |${SessionStartContactEMail}                                            |
|Check Mail                 |$Requestor@${TPAMEMailDomain}||Expired Session still active||$RequestID|
|Check Mail                 |${SystemEMail}               ||Expired Session still active||$RequestID|
|Delete Mails               |$Requestor@${TPAMEMailDomain}                                          |
|Delete Mails               |${SystemEMail}                                                         |
|Check All Mailboxes No Mail|Session                      ||$RequestID                              |
#|pause                      |900000                                                                      |
#|Check Mail                 |${SystemEMail}               ||Session Post-Request Notification||$RequestID|
#|Check Mail                 |${PostSessionProfileEMail}   ||Session Post-Request Notification||$RequestID|
#|Delete Mails               |${PostSessionProfileEMail}                                                  |


!|scenario   |Post-Session Notification                                                |
|Check Mail  |${SystemEMail}            ||Session Post-Request Notification||$RequestID|
|Check Mail  |${PostSessionProfileEMail}||Session Post-Request Notification||$RequestID|
|Delete Mails|${SystemEMail}                                                           |
|Delete Mails|${PostSessionProfileEMail}                                               |




#!|scenario                       |Manage Sessions                                                                 |
#|Manage Session and Check Results|${UserCollectionRequestor}||${UserCollectionApprover}||${UserCollectionReviewer}|
#|Manage Session and Check Results|${GroupSystemRequestor}   ||${GroupSystemApprover}   ||${GroupSystemReviewer}   |
#|Manage Session and Check Results|${GlobalGroupRequestor}   ||${GlobalGroupApprover}   ||${GlobalGroupReviewer}   |


!|scenario        |Change Account Primary EMail|EMail                                                                                                   |
|$res=            |CLI                         |${CLIBatch} UpdateAccount --System ${SystemName} --Account ${ManagedAccount} --ReleaseNotifyEmail @EMail|
|Verify_Contain_OR|$res;;successful                                                                                                                     |

!|scenario                   |Primary Account EMail Changed      |
|Change Account Primary EMail|new${AccountEMail}                 |
|pause                       |120000                             |
|Check Mail                  |${AccountEMail}||modified||modified|
|Delete Mails                |${AccountEMail}                    |
|Change Account Primary EMail|${AccountEMail}                    |


!|scenario        |Set Approvers Count|SystemName                                 |                                 |AccountName                                 |                                |ApprCount                                |
|$res=            |CLI                |${CLIBatch} UpdateEGPAccount --System @SystemName --Account @AccountName --MinApprovers @ApprCount --EscalationEmail ${ReviewerEscalationEMail} --SessionStartNotifyEmail ${SessionStartContactEMail}|
|Verify_Contain_OR|$res;;successful                                                                                                                                                                                                         |


!| scenario       |Request Session      |System                      |                      |Account                      |                     |ForUser                     |
|$res=            |CLI                  |${CLIBatch} AddSessionRequest --SystemName @System --AccountName @Account --ForUserName @ForUser --RequestNotes \"${RequestReason}\"|
|Verify_Contain_OR|$res;;submitted                                                                                                                                           |
|$RequestID=      |get_session_RequestID|$res                                                                                                                                |

!| scenario        |Request Session via UI Not Immediate|System|        |Account||ForUser||Result|
|Logout                                                                                          |
|Login             |${TPAMURL}                          |      |@ForUser|       |${UserPwd}      |
|pause             |20000                                                                        |
|clickAndWait      |link=Add Session Request                                                     |
|type;             |id=SystemNm                         |@System                                 |
|type;             |id=AccountNm                        |@Account                                |
|click             |id=Accounts                         |                                        |
|click             |//input[@type='checkbox']                                                    |
|click             |id=Details                                                                   |
|type;             |id=RequestReason                    |session request reason                  |
|typeKeys;         |id=RequestReason                    |a                                       |
|click             |id=cb_Immed                                                                  |
|$Years=           |getEval                             |var d = new Date();d.getUTCFullYear()+1;|
|type;             |id=Year                             |$Years                                  |
|click             |id=SubmitChanges                                                             |
|waitForTextPresent|@Result                                                                      |


!|scenario            |Approve Session    |Approver               |
|Login                |${TPAMURL}         | |@Approver||${UserPwd}|
|pause                |20000                                      |
|click                |id=Approvals                               |
|waitForElementPresent|link=$RequestID                            |
|clickAndWait         |link=$RequestID                            |
|waitForElementPresent|id=ResponseComment |                       |
|type;                |id=ResponseComment |ok to approve          |
|typeKeys;            |id=ResponseComment |a                      |
|click                |id=ApproveReq                              |
|waitForTextPresent   |*The response * was submitted successfully*|

!|scenario            |Review Session     |Reviewer              |
|Logout                                                          |
|Login                |${TPAMURL}         ||@Reviewer||${UserPwd}|
|pause                |20000                                     |
|click                |id=PendingReviews                         |
|waitForElementPresent|link=$RequestID                           |
|clickAndWait         |link=$RequestID                           |
|pause                |3000                                      |
|waitForElementPresent|id=NewReviewComment|                      |
|type;                |id=NewReviewComment|I saw i               |
|typeKeys;            |id=NewReviewComment|t                     |
|pause                |3000                                      |
|click                |id=CompleteReviewButton                   |
|waitForTextPresent   |*Saved Successfully*                      |


!|scenario            |Open Session|Requestor              |
|Logout                                                    |
|Login                |${TPAMURL}  ||@Requestor||${UserPwd}|
|pause                |20000                               |
|click                |id=CurrentRequests                  |
|waitForElementPresent|link=$RequestID                     |
|clickAndWait         |link=$RequestID                     |
|waitForElementPresent|id=StartSessionButton               |
|click                |id=StartSessionButton               |
|pause                |1000000                             |
#|type;                |id=ResponseComment |cancel                 |
#|typeKeys;            |id=ResponseComment |request                |
#|click                |id=SubmitChanges                           |
#|waitForTextPresent   |*The response * was submitted successfully*|
#|click                |id=TerminateSessionButton|
#|pause                |10000                    |


!|scenario            |Open Session For Periodic Review|Requestor              |
|Logout                                                                        |
|Login                |${TPAMURL}                      ||@Requestor||${UserPwd}|
|pause                |20000                                                   |
|click                |id=CurrentRequests                                      |
|waitForElementPresent|link=$RequestID                                         |
|clickAndWait         |link=$RequestID                                         |
|waitForElementPresent|id=StartSessionButton                                   |
|click                |id=StartSessionButton                                   |
|pause                |90000                                                   |
|type;                |id=ResponseComment              |cancel                 |
|typeKeys;            |id=ResponseComment              |request                |
|click                |id=SubmitChanges                                        |
#|waitForTextPresent   |*The response * was submitted successfully*|


!|scenario                       |Session Periodic Review Requirement                                                                                                                      |
|Open Session For Periodic Review|$Requestor                                                                                                                                               |
|click                           |link=$Requestor                                                                                                                                          |
|click                           |link=About TPAM                                                                                                                                          |
|click                           |css=button                                                                                                                                               |
|$res=                           |getText                                      |id=footerServerTime                                                                                        |
|$res2=                          |getEval                                      |var i1 = "$res"; i1+=""; var i2 = i1.indexOf(":"); i2+=0; i3 = i2 + 1; i4 = i1.substring(i3, i3+2); i4+="";|
|$msec1=                         |getEval                                      |var i1 = (60 - $res2) * 60 * 500; i1+=0;                                                                   |
|$msec2=                         |getEval                                      |var i1 = (65 - $res2) * 60 * 500; i1+=0;                                                                   |
|pause                           |$msec1                                                                                                                                                   |
|Check No Mail                   |${UserAccountReviewer}@${TPAMEMailDomain}    |                |Outstanding Review Requirements                |                |$RequestID               |
|Check No Mail                   |${UserSystemReviewer}@${TPAMEMailDomain}     |                |Outstanding Review Requirements                |                |$RequestID               |
|Check No Mail                   |${UserCollectionReviewer}@${TPAMEMailDomain} |                |Outstanding Review Requirements                |                |$RequestID               |
|Check No Mail                   |${GroupAccountReviewer}@${TPAMEMailDomain}   |                |Outstanding Review Requirements                |                |$RequestID               |
|Check No Mail                   |${GroupSystemReviewer}@${TPAMEMailDomain}    |                |Outstanding Review Requirements                |                |$RequestID               |
|Check No Mail                   |${GroupCollectionReviewer}@${TPAMEMailDomain}|                |Outstanding Review Requirements                |                |$RequestID               |
|Check No Mail                   |${GlobalGroupReviewer}@${TPAMEMailDomain}    |                |Outstanding Review Requirements                |                |$RequestID               |
|Check No Mail                   |${GlobalGroupApprover}@${TPAMEMailDomain}    |                |Outstanding Review Requirements                |                |$RequestID               |
|Check No Mail                   |${AuditorEMail}                              |                |Outstanding Review Requirements                |                |$RequestID               |
|pause                           |$msec2                                                                                                                                                   |
|Check Reviewers Mailboxes       |Outstanding Review Requirements              |                |$RequestID                                                                                |
|Clear Reviewers Mailboxes                                                                                                                                                                 |
|Check All Mailboxes No Mail     |Outstanding Review Requirements              |                |$RequestID                                                                                |





########### Parameter @immediate can be 1 (Yes) or 2 (No) #############
!|scenario         |Change Review Notification Settings Not Immediate|
|clickAndWait      |link=Global Settings                             |
|click             |id=R88_2                                         |
|select;           |id=T89               |label=1x/hour              |
|click             |id=SubmitChanges                                 |
|waitForTextPresent|Global Settings changes saved successfully       |

!|scenario         |Change Review Notification Settings Immediate|
|clickAndWait      |link=Global Settings                         |
|click             |id=R88_1                                     |
|select;           |id=T89            |label=Disabled            |
|click             |id=SubmitChanges                             |
|waitForTextPresent|Global Settings changes saved successfully   |


!|scenario     |Check Periodic Review Notifications|Requestor|             |Approver|  |Reviewer |
|Login         |${TPAMAdminURL}                    |         |${TPAMMaster}|        |${MasterPwd}|
|pause         |20000                                                                            |
|Change Review Notification Settings Not Immediate                                               |
|$Requestor=   |getEval                            |"@Requestor"                                 |
|$Approver=    |getEval                            |"@Approver"                                  |
|$Reviewer=    |getEval                            |"@Reviewer"                                  |
|Session Request                                                                                 |
|Session Request Response                                                                        |
|Session Periodic Review Requirement                                                             |
|Login         |${TPAMAdminURL}                    |         |${TPAMMaster}|        |${MasterPwd}|
|pause         |20000                                                                            |
|Change Review Notification Settings Immediate                                                   |
|Review Session|@Reviewer                                                                        |



!|scenario                          |Change Settings                             |
|Login                              |${TPAMAdminURL}||${TPAMMaster}||${MasterPwd}|
|pause                              |20000                                       |
|Change Review Notification Settings|2              ||1                          |



!| scenario|Check Approvers Mailboxes      |subject|        |body  |
|Check Mail|${UserAccountApproverEMail}    |       |@subject||@body|
|Check Mail|${UserSystemApproverEMail}     |       |@subject||@body|
|Check Mail|${UserCollectionApproverEMail} |       |@subject||@body|
|Check Mail|${GroupAccountApproverEMail}   |       |@subject||@body|
|Check Mail|${GroupSystemApproverEMail}    |       |@subject||@body|
|Check Mail|${GroupCollectionApproverEMail}|       |@subject||@body|
|Check Mail|${GlobalGroupApproverEMail}    |       |@subject||@body|


!| scenario  |Clear Approvers Mailboxes      |
|Delete Mails|${UserAccountApproverEMail}    |
|Delete Mails|${UserSystemApproverEMail}     |
|Delete Mails|${UserCollectionApproverEMail} |
|Delete Mails|${GroupAccountApproverEMail}   |
|Delete Mails|${GroupSystemApproverEMail     |
|Delete Mails|${GroupCollectionApproverEMail}|
|Delete Mails|${GlobalGroupApproverEMail}    |




!| scenario|Check Reviewers Mailboxes      |subject|        |body  |
|Check Mail|${UserAccountReviewerEMail}    |       |@subject||@body|
|Check Mail|${UserSystemReviewerEMail}     |       |@subject||@body|
|Check Mail|${UserCollectionReviewerEMail} |       |@subject||@body|
|Check Mail|${GroupAccountReviewerEMail}   |       |@subject||@body|
|Check Mail|${GroupSystemReviewerEMail}    |       |@subject||@body|
|Check Mail|${GroupCollectionReviewerEMail}|       |@subject||@body|
|Check Mail|${GlobalGroupReviewerEMail}    |       |@subject||@body|
|Check Mail|${GlobalGroupApproverEMail}    |       |@subject||@body|
|Check Mail|${AuditorEMail}                |       |@subject||@body|


!| scenario  |Clear Reviewers Mailboxes      |
|Delete Mails|${UserAccountReviewerEMail}    |
|Delete Mails|${UserSystemReviewerEMail}     |
|Delete Mails|${UserCollectionReviewerEMail} |
|Delete Mails|${GroupAccountReviewerEMail}   |
|Delete Mails|${GroupSystemReviewerEMail}    |
|Delete Mails|${GroupCollectionReviewerEMail}|
|Delete Mails|${GlobalGroupReviewerEMail}    |
|Delete Mails|${GlobalGroupApproverEMail}    |
|Delete Mails|${AuditorEMail}                |


!|scenario         |Change Notification Body|notificationName|             |notificationBody|
|Login             |${TPAMAdminURL}         |                |${TPAMMaster}|  |${MasterPwd} |
|pause             |15000                                                                   |
|clickAndWait      |link=Email Config                                                       |
|select;           |id=EmailConfigID        |label=@notificationName                        |
|pause             |1000                                                                    |
|type;             |id=EmailBody            |@notificationBody                              |
|typeKeys;         |id=EmailBody            |@notificationBody                              |
|click             |id=SubmitChanges                                                        |
|waitForTextPresent|All Email changes saved successfully                                    |


!|scenario|Session Cleanup  |accountName                                                              |
|$res=    |RunBatchGetOutput|CleanupSession;${SystemAddress};${FunctAcct};${FunctAcctPwd};@accountName|
