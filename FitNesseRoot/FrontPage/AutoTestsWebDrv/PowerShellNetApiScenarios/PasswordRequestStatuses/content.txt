!|import          |
|fitnesse.fixtures|

!|Library    |
|echo fixture|

!include -c <AutoTestsWebDrv.ScenarioLibrary
!include -c <PowerShellNetApiScenarios.ScenarioLibrary

!*> Prepare Environment (creating system, account)
!|script                                                                                 |
|Create Account on System                                                                |
|Add System                                                                              |
|Add account    |${ManagedAccount}|with password|${ManagedAccountPwdNew}                 |
|Set Permissions|"PPM Requestor"  |on  account  |${ManagedAccount}|for user|${API_user_1}|
|Set Permissions|"PPM Approver"   |on  account  |${ManagedAccount}|for user|${API_user_2}|
*!

!3 Immediate request
!|script                                                        |
|Request Pwd by             |${API_user_1}                      |
|Get Password Request Status|${ManagedAccount}.*Pending Approval|
|Approve Pwd by             |${API_user_2}                      |
|Get Password Request Status|${ManagedAccount}.*Active/Approved |
|Retrieve Account Password                                      |
|Get Password Request Status|${ManagedAccount}.*Active/Approved |
|Cancel Request by          |${API_user_1}                      |
|Get Password Request Status|${ManagedAccount}.*Expired         |

!3 Request is not immediate
!|script                                                                                                                                                                                     |
|Open                       |${TPAMURL}   |                                    |${TPAMAdmin}                            |                           |${DefaultPwd}                           |
|$Months=                   |getEval      |var d = new Date();d.setMinutes(d.getMinutes()+1); d.setDate(d.getDate()+1);var s = d.getMonth()+1;if ((s + "").length == 1) s = "0" + s;return s;|
|$Days=                     |getEval      |var d = new Date();d.setMinutes(d.getMinutes()+1); d.setDate(d.getDate()+1);var s = d.getDate(); if ((s + "").length == 1) s = "0" + s;return s;  |
|$Years=                    |getEval      |var d = new Date();d.setMinutes(d.getMinutes()+1); d.setDate(d.getDate()+1); return d.getFullYear();                                              |
|Logout Paradmin                                                                                                                                                                             |
|Request Pwd by             |${API_user_1}|with additional conditions          |-RequestImmediate N -ReleaseDuration 15 -RequestedReleaseDate $Years/$Months/$Days                           |
|Get Password Request Status|${ManagedAccount}.*Pending Approval                                                                                                                             |
|Approve Pwd by             |${API_user_2}                                                                                                                                                   |
|Get Password Request Status|${ManagedAccount}.* Approved                                                                                                                                    |
|Cancel Request by          |${API_user_1}                                                                                                                                                   |
|Get Password Request Status|${ManagedAccount}.* Canceled                                                                                                                                    |
|                                                                                                                                                                                            |

!|script                                                |
|Request Pwd by             |${API_user_1}              |
|$firstReqId =              |echo      |$RequestID      |
|Request Pwd by             |${API_user_1}              |
|Approve Pwd by             |${API_user_2}              |
|$RequestID=                |echo      |$firstReqId     |
|Get Password Request Status|${ManagedAccount}.*Canceled|


!*> Clean Up
!|script                         |
|Delete Account|${ManagedAccount}|
|Delete System |${SystemName}    |
*!
