!*> Test description
Prevent deleting of domain accounts or domain systems if the account is used as PSM domain session authentication.
*!

!define psConnectOptions {-tpamAddress ${TPAMHost} -keyFile ${API_user_1} -apiUser ${API_user_1}}
!define ADSystemName {${prefix}ADSystem}
!define ADAccountName {${prefix}ADAccount}
!define secSystemName {${prefix}secSystem}
!define psmAccountName {${prefix}pAccount}
!define netBios {${prefix}lab}
!define domainName {${netBios}.spb.qsft}
!define SystemTimeout {34}

!define FilePath {${ProjDir}\Scripts\Batch\${prefix}temp.txt}
!define batchAccntDltFailed {Ignoring delete of the following accounts because other accounts currently depend on them for PSM session authentication}
!define batchSysDltFailed {Ignoring the following delete system operations because other systems currently depend on their accounts}
!define RestoreAccntResult {The domain account used for PSM session authentication has been soft-deleted. It will be cleared and PSM authentication set to Local TPAM}
!define RestoreSystemResult {It will be cleared and PSM authentication set to Local TPAM}

!include -c <AutoTestsWebDrv.PowerShellNetApiScenarios.ScenarioLibrary
!include -c >TestSpecific

!* Prepare environment
!|script                                                                                                                                                                                                             |
|Add system    |${ADSystemName}  |with address|7.6.5.4         |platform    |"Windows Active Dir" |managed by |admin |additional parameters|-functAcctPwd T0PSecret -domainName ${domainName} -NetBiosName ${netBios}|
|Add account   |${ADAccountName} |on system   |${ADSystemName} |with options|-description test                                                                                                                       |
|Add system    |${secSystemName} |with address|1.2.3.4         |platform    |Windows              |managed by |master|additional parameters|-functAcctPwd T0PSecret                                                  |
|Add account   |${psmAccountName}|on system   |${secSystemName}|with options|-AutoFlag N                                                                                                                             |
|Enable PSM for|${psmAccountName}|on system   |${secSystemName}|with options|-passwordMethod "Windows Domain Account" -proxyType "RDP - Automatic Login Using Password" -domainAccount ${domainName}\${ADAccountName}|
*!

!3 Try to delete AD account and system
!|script                                                                                                                              |
|Try to Delete Account|${ADAccountName}|on system  |${ADSystemName}|with result|the domain account used for PSM session authentication|
|Try to delete system |${ADSystemName} |with result|failed .* the domain account for PSM session authentication                       |

!3 Try to delete AD account and system using batch
!|script                                                                                                           |
|Try to use batch to Delete Account|${ADAccountName}|on system  |${ADSystemName}|with result|${batchAccntDltFailed}|
|Try to use batch to Delete system |${ADSystemName} |with result|${batchSysDltFailed}                              |

!3 Try to restore deleted account with domain account to authenticate PSM session
!|script                                                                                                                       |
|Try to Delete Account|${psmAccountName}|on system|${secSystemName}|with result|${psmAccountName} has been successfully deleted|
|Delete System        |${ADSystemName}                                                                                         |
|Restore Account      |${psmAccountName}|on system|${secSystemName}|with result|${RestoreAccntResult}                          |

!* Restore environment
!|script                                                                                                                                                                                                                   |
|Add system             |${ADSystemName}  |with address|7.6.5.4         |platform    |"Windows Active Dir"|managed by|admin|additional parameters|-functAcctPwd T0PSecret -domainName ${domainName} -NetBiosName ${netBios}|
|Add account            |${ADAccountName} |on system   |${ADSystemName} |with options|-description test                                                                                                                    |
|Update PSM settings for|${psmAccountName}|on system   |${secSystemName}|with options|-passwordMethod "Windows Domain Account" -domainAccount ${domainName}\${ADAccountName}                                               |
*!
!3 Restore system with account with domain account to authenticate PSM session
!|script                                                           |
|Delete System |${secSystemName}                                   |
|Delete System |${ADSystemName}                                    |
|Restore System|${secSystemName}|with result|${RestoreSystemResult}|

!include -c <AutoTestsWebDrv.AccessPolicies.ScenarioLibrary

!* Cleanup
!|script                                                   |
|Delete System     |${secSystemName}                       |
|Open              |${TPAMURL}||${TPAMAdmin}||${DefaultPwd}|
|Hard-Delete System|${secSystemName}                       |
*!
