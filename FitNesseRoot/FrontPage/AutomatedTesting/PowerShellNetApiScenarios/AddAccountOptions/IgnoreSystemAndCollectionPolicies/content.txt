!* Test description
When the flag is set on an account, no System-level permission assignments should be honored.
Due to Global Setting "Ignore Policies includes collection membership", permissions for "collection of systems" from further down the hierarchy should ignored too.
Permissions for "collection of accounts" should still be respected.
*!

!define psConnectOptions {-tpamAddress ${TPAMHost} -keyFile ${API_user_1} -apiUser ${API_user_1}}
!define SystemDescription {Test system for powershell}
!define collDescription {Test collection}
!define groupDescription {Test group}
!define FunctAcctPwd {T0PSecret}
!define NonPolicyAccount {${prefix}_ignoresyspol}
!define underPolicyAccount {${prefix}_withsyspol}
!define CollectionName {${prefix}AccntCollctn}
!define CollectionName2 {${prefix}SystemCollctn}
!define testGroup {${prefix}PermGroup}
!include -c <AutomatedTesting.PowerShellNetApiScenarios.ScenarioLibrary

!|script               |
|Turn On Global Setting|

!*> Create System, accounts and collections
!|script                                                                                                                       |
|Add System                                                                                                                    |
|Add account   |${NonPolicyAccount}  |on system    |${SystemName}|with options |-IgnoreSystemPoliciesFlag Y -MinimumApprovers 0|
|Add account   |${underPolicyAccount}|on system    |${SystemName}|with options |-IgnoreSystemPoliciesFlag N -MinimumApprovers 0|
|Add Collection|${CollectionName}                                                                                              |
|Add Collection|${CollectionName2}                                                                                             |
|Add System    |${SystemName}        |to collection|${CollectionName2}                                                         |
|Add Account   |${underPolicyAccount}|from system  |${SystemName}|to collection|${CollectionName}                              |
|Add Account   |${NonPolicyAccount}  |from system  |${SystemName}|to collection|${CollectionName}                              |
|Add Group     |${testGroup}                                                                                                   |
|Add Member    |${API_user_2}        |to group     |${testGroup}                                                               |
*!

!3 System-level Access Policies are ignored. Account-level policies are used for permissions.
!note System Level permissions
!|script                                                                                                                            |
|Set Permissions   |Requestor            |on system  |${SystemName}      |for user   |${API_user_2}                                 |
|Try to Request Pwd|${NonPolicyAccount}  |by user    |${API_user_2}      |with result|You are not authorized to request the password|
|Try to Request Pwd|${underPolicyAccount}|by user    |${API_user_2}      |with result|submitted                                     |
|$RequestID=       |get_RequestID        |$res                                                                                      |
|Cancel Request by |${API_user_2}                                                                                                   |
|Set Permissions   |Requestor            |on  account|${NonPolicyAccount}|for user   |${API_user_2}                                 |
|Try to Request Pwd|${NonPolicyAccount}  |by user    |${API_user_2}      |with result|submitted                                     |
|$RequestID=       |get_RequestID        |$res                                                                                      |
|Cancel Request by |${API_user_2}                                                                                                   |
|Revoke Permissions|Requestor            |on  account|${NonPolicyAccount}|for user   |${API_user_2}                                 |
|Revoke Permissions|Requestor            |on  system |${SystemName}      |for user   |${API_user_2}                                 |

!note The permissions are propagated by an account collection membership.
!|script                                                                                           |
|Set Permissions   |Requestor            |on collection|${CollectionName}|for user   |${API_user_2}|
|Try to Request Pwd|${underPolicyAccount}|by user      |${API_user_2}    |with result|submitted    |
|$RequestID=       |get_RequestID        |$res                                                     |
|Cancel Request by |${API_user_2}                                                                  |
|Try to Request Pwd|${NonPolicyAccount}  |by user      |${API_user_2}    |with result|submitted    |
|$RequestID=       |get_RequestID        |$res                                                     |
|Cancel Request by |${API_user_2}                                                                  |
|Revoke Permissions|Requestor            |on collection|${CollectionName}|for user   |${API_user_2}|

!note The permissions are propagated by an system collection membership.
!|script                                                                                                                             |
|Set Permissions   |Requestor            |on collection|${CollectionName2}|for user   |${API_user_2}                                 |
|Try to Request Pwd|${underPolicyAccount}|by user      |${API_user_2}     |with result|submitted                                     |
|$RequestID=       |get_RequestID        |$res                                                                                       |
|Cancel Request by |${API_user_2}                                                                                                    |
|Try to Request Pwd|${NonPolicyAccount}  |by user      |${API_user_2}     |with result|You are not authorized to request the password|
|Revoke Permissions|Requestor            |on collection|${CollectionName2}|for user   |${API_user_2}                                 |

!3 Permission for groups
!note System Level Permission
!|script                                                                                                                            |
|Set Permissions   |Requestor            |on system  |${SystemName}      |for group  |${testGroup}                                  |
|Try to Request Pwd|${NonPolicyAccount}  |by user    |${API_user_2}      |with result|You are not authorized to request the password|
|Try to Request Pwd|${underPolicyAccount}|by user    |${API_user_2}      |with result|submitted                                     |
|$RequestID=       |get_RequestID        |$res                                                                                      |
|Cancel Request by |${API_user_2}                                                                                                   |
|Set Permissions   |Requestor            |on  account|${NonPolicyAccount}|for group  |${testGroup}                                  |
|Try to Request Pwd|${NonPolicyAccount}  |by user    |${API_user_2}      |with result|submitted                                     |
|$RequestID=       |get_RequestID        |$res                                                                                      |
|Cancel Request by |${API_user_2}                                                                                                   |
|Revoke Permissions|Requestor            |on  account|${NonPolicyAccount}|for group  |${testGroup}                                  |
|Revoke Permissions|Requestor            |on  system |${SystemName}      |for group  |${testGroup}                                  |

!note Account collection level
!|script                                                                                          |
|Set Permissions   |Requestor            |on collection|${CollectionName}|for group  |${testGroup}|
|Try to Request Pwd|${underPolicyAccount}|by user      |${API_user_2}    |with result|submitted   |
|$RequestID=       |get_RequestID        |$res                                                    |
|Cancel Request by |${API_user_2}                                                                 |
|Try to Request Pwd|${NonPolicyAccount}  |by user      |${API_user_2}    |with result|submitted   |
|$RequestID=       |get_RequestID        |$res                                                    |
|Cancel Request by |${API_user_2}                                                                 |
|Revoke Permissions|Requestor            |on collection|${CollectionName}|for group  |${testGroup}|

!note System collection level
!|script                                                                                                                             |
|Set Permissions   |Requestor            |on collection|${CollectionName2}|for group  |${testGroup}                                  |
|Try to Request Pwd|${underPolicyAccount}|by user      |${API_user_2}     |with result|submitted                                     |
|$RequestID=       |get_RequestID        |$res                                                                                       |
|Cancel Request by |${API_user_2}                                                                                                    |
|Try to Request Pwd|${NonPolicyAccount}  |by user      |${API_user_2}     |with result|You are not authorized to request the password|
|Revoke Permissions|Requestor            |on collection|${CollectionName} |for group  |${testGroup}                                  |

!*> Removing section
!|script                             |
|Delete Collection|${CollectionName} |
|Delete Collection|${CollectionName2}|
|Delete Group     |${testGroup}      |
|Delete System    |${SystemName}     |
*!

!|script                |
|Turn Off Global Setting|
