!* Test Description
When you create a template you can choose check or do not check "Retain User/Group Permissions in the template" checkbox.
In first case all permission should transfer to target template. 
*!

!define testUser {${prefix}Apprvr}
!define firstGroupName {${prefix}Apprvrs}
!define groupDescription {Test}
!define userPolicy {Approver-Requestor}
!define groupPolicy {Approver}

!define newSystemAddress {10.30.45.65}

!include -c <AutomatedTesting.AccountDiscovery.ScenarioLibrary
!include -c <AutomatedTesting.PowerShellNetApiScenarios.ScenarioLibrary
!include -c <PropagateOptionsFromTemplate.ScenarioLibrary

!*> Prepare
!|script                                                                                                                                                      |
|Add User       |${testUser}                                                                                                                                  |
|Add Group      |${firstGroupName}                                                                                                                            |
|Add system     |${SystemName}   |with address|${SystemAddress}|platform |${SystemPlatform}|managed by|${FunctAcct}|additional parameters|-description "Asert"|
|Set Permissions|${userPolicy}   |on system   |${SystemName}   |for user |${testUser}                                                                         |
|Set Permissions|"${groupPolicy}"|on system   |${SystemName}   |for group|${firstGroupName}                                                                   |
|pause          |${ApplyNewPoliciesInterval}                                                                                                                  |
*!

!2 "Retain User/Group Permissions in the template" is checked.

!4 Create system, make template from system and create system from template
!|script                                                                                                                                                                                               |
|Make System Template|${TemplateName} |from           |${SystemName}                                                         |with account|${FunctAcct}|retain permissions|true|retain membership|false|
|Try to Add system   |${newSystemName}|with parameters|-systemAddress ${newSystemAddress} -templateSystemName ${TemplateName}|with result |System changes for ${newSystemName} saved successfully      |
|pause               |${ApplyNewPoliciesInterval}                                                                                                                                                      |

!4 Check permissions on new system.
!|script                                                                                                                      |
|List Policies by filter|-systemName ${newSystemName} -userName ${testUser}       |contains|${testUser}\s+${userPolicy}       |
|List Policies by filter|-systemName ${newSystemName} -groupName ${firstGroupName}|contains|${firstGroupName}\s+${groupPolicy}|

!4 Delete template and system that has been created from template
!|script                                              |
|Delete System|${newSystemName}                       |
|Open         |${TPAMURL}||${TPAMAdmin}||${DefaultPwd}|
|Remove system|${TemplateName}                        |


!2 "Retain User/Group Permissions in the template" is unchecked.
!4 Create system, make template from system and create system from template
!|script                                                                                                                                                                                                |
|Make System Template|${TemplateName} |from           |${SystemName}                                                         |with account|${FunctAcct}|retain permissions|false|retain membership|false|
|Try to Add system   |${newSystemName}|with parameters|-systemAddress ${newSystemAddress} -templateSystemName ${TemplateName}|with result |System changes for ${newSystemName} saved successfully       |
|pause               |${ApplyNewPoliciesInterval}                                                                                                                                                       |

!4 Check permissions on new system.
!|script                                                                                                           |
|List Policies by filter|-systemName ${newSystemName} -userName ${testUser}       |does not contains|${userPolicy} |
|List Policies by filter|-systemName ${newSystemName} -groupName ${firstGroupName}|does not contains|${groupPolicy}|

!2 Clean up
!|script                       |
|Delete User |${testUser}      |
|Delete Group|${firstGroupName}|
